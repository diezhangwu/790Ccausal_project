---
title: "data_analysis"
output: html_notebook
---


#### import dataset and data cleaning
```{r}
library(dplyr)
library(haven)
library(ggplot2)
dataset <- read_stata("data/Regression-and-Event-Study-Analyses.dta")
```


#### Descriptive statistics
```{r}
library(dplyr)
#demographics
#all
dataset %>%
  select(percent_female,percent_black,percent_nonwhite,percent_white,percent_other_nonwhite,percent_foreign,percent_age_less15,percent_age_15to44,percent_age_45plus) %>%
  summarise_all(list(mean = ~mean(.), sd = ~sd(.)))
#treatment group
dataset %>%
  filter(filter==1) %>%
  summarise(n=n())
dataset %>%
  filter(filter==1) %>%
  select(percent_female,percent_black,percent_nonwhite,percent_white,percent_other_nonwhite,percent_foreign,percent_age_less15,percent_age_15to44,percent_age_45plus) %>%
  summarise_all(list(mean = ~mean(.), sd = ~sd(.))) 
#control group
dataset %>%
  filter(filter<1) %>%
  summarise(n=n())
dataset %>%
  filter(filter<1) %>%
  select(percent_female,percent_black,percent_nonwhite,percent_white,percent_other_nonwhite,percent_foreign,percent_age_less15,percent_age_15to44,percent_age_45plus) %>%
  summarise_all(list(mean = ~mean(.), sd = ~sd(.)))

#Outcomes: filtration
#all
dataset %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#treatment
dataset %>%
   filter(filter==1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#control
dataset %>%
  filter(filter<1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))

test <- dataset %>%
  filter(filter<1 & filter>0)

#Outcomes: chlorination
#treatment
dataset %>%
   filter(chlorination==1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#control
dataset %>%
  filter(chlorination<1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))

#Outcomes: clean water project
#treatment
dataset %>%
   filter(water_project==1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#control
dataset %>%
  filter(water_project<1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
```


### RD Regression

Model specification:

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \boldsymbol{Z}_t\beta_2+ \beta_3 t + \beta_4 I(t > t^*) + \epsilon_{t}$

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \boldsymbol{Z}_t\beta_2 + \beta_3 t + \beta_4 I(t > t^*) + \beta_5 I(t > t^*)* t  + \epsilon_{t}$

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \beta_2 t + \beta_3 I(t > t^*) + \epsilon_{t}$

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \beta_2 t + \beta_3 I(t > t^*) + \beta_4 I(t > t^*)* t  + \epsilon_{t}$

```{r}
dat <- dataset %>% 
  select(year,
         city,
         city_id,
         percent_female,
         percent_nonwhite,
         percent_foreign,
         percent_age_less15,
         percent_age_15to44,
         percent_age_45plus, 
         ln_mortality_rate,
         ln_mortality_under1_rate,
         ln_typhoid_rate,
         ln_diarrhea_rate,
         filter, chlorination, water_project) %>% 
    mutate(filter = ifelse(filter == 1, 1, 0),
         chlorination = ifelse(chlorination == 1, 1, 0),
         water_project = ifelse(water_project == 1, 1, 0))

start_year <- dat %>% 
  arrange(city, by_group = year) %>% 
  mutate(filter1 = ifelse(filter == 0, 10000, year),
          ch1 = ifelse(chlorination == 0, 10000, year),
         water1 = ifelse(water_project == 0, 10000, year)) %>% 
  group_by(city) %>% 
  summarise(filter_start = min(filter1),
            ch_start = min(ch1),
            water_start = min(water1)) %>% 
  mutate(filter_start = ifelse(filter_start == 10000, 1940, filter_start),
         ch_start = ifelse(ch_start == 10000, 1940, ch_start),
         water_start = ifelse(water_start == 10000, 1940, water_start))

dat <- left_join(dat, start_year) %>% 
  mutate(filter_t = year - filter_start,
         ch_t = year - ch_start,
         water_t = year - water_start,
         filter_knot = ifelse(filter_t <=0, 0, 1),
         ch_knot = ifelse(ch_t <= 0, 0, 1),
         water_knot = ifelse(water_t <= 0, 0, 1)) 


```

## treatment effect of water filteration
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))
```

## treatment effect of chlorination
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))
```

### clean water project
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

```


### RD model 2

```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot + filter_knot*filter_t, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot + filter_knot*filter_t, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot*filter_t, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot + filter_knot*filter_t, data = dat))
```

## chlorination
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))
```

## plot observed data with fitted line
```{r}
dat.pred <- dat %>% select(
                           percent_female,
                           percent_nonwhite,
                           percent_foreign,
                           percent_age_less15,
                           percent_age_15to44,
                           percent_age_45plus,
                           ch_t, 
                           ch_knot)

mod.mort <- glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)

y.mort <- predict(mod.mort, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_mortality_rate)) +
  geom_point(aes(x = dat$ch_t, y = y.mort, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log all-cause mortality")+
  theme(legend.position = "none")



mod.in <- glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)

y.in <- predict(mod.in, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_mortality_under1_rate) )+
  geom_point(aes(x = dat$ch_t, y = y.in, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log infant mortality")+
  theme(legend.position = "none")



mod.ty <- glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)

y.ty <- predict(mod.ty, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_typhoid_rate) )+
  geom_point(aes(x = dat$ch_t, y = y.ty, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log typhoid mortality")+
  theme(legend.position = "none")



mod.di <- glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)


y.di <- predict(mod.di, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_diarrhea_rate) )+
  geom_point(aes(x = dat$ch_t, y = y.di, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log diarrhea mortality")+
  theme(legend.position = "none")

```




## water project
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))
```





