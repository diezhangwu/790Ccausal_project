---
title: "data_analysis"
output: html_notebook
---


#### import dataset and data cleaning
```{r}
library(dplyr)
library(haven)
library(ggplot2)
dataset <- read_stata("data/Regression-and-Event-Study-Analyses.dta")
```


#### Descriptive statistics
```{r descriptive}
#demographics
#all
dataset %>%
  select(percent_female,percent_black,percent_nonwhite,percent_white,percent_other_nonwhite,percent_foreign,percent_age_less15,percent_age_15to44,percent_age_45plus) %>%
  summarise_all(list(mean = ~mean(.), sd = ~sd(.)))
#treatment group
dataset %>%
  filter(filter==1) %>%
  summarise(n=n())
dataset %>%
  filter(filter==1) %>%
  select(percent_female,percent_black,percent_nonwhite,percent_white,percent_other_nonwhite,percent_foreign,percent_age_less15,percent_age_15to44,percent_age_45plus) %>%
  summarise_all(list(mean = ~mean(.), sd = ~sd(.))) 
#control group
dataset %>%
  filter(filter<1) %>%
  summarise(n=n())
dataset %>%
  filter(filter<1) %>%
  select(percent_female,percent_black,percent_nonwhite,percent_white,percent_other_nonwhite,percent_foreign,percent_age_less15,percent_age_15to44,percent_age_45plus) %>%
  summarise_all(list(mean = ~mean(.), sd = ~sd(.)))

#Outcomes: filtration
#all
dataset %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#treatment
dataset %>%
   filter(filter==1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#control
dataset %>%
  filter(filter<1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))

test <- dataset %>%
  filter(filter<1 & filter>0)

#Outcomes: chlorination
#treatment
dataset %>%
   filter(chlorination==1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#control
dataset %>%
  filter(chlorination<1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))

#Outcomes: clean water project
#treatment
dataset %>%
   filter(water_project==1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
#control
dataset %>%
  filter(water_project<1) %>%
  select(mortality_rate,mortality_under1_rate,typhoid_rate,diarrhea_rate) %>%
  summarise_all(list(mean = ~mean(.,na.rm = T), sd = ~sd(.,na.rm = T)))
```


### RD Regression

Model specification:

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \boldsymbol{Z}_t\beta_2+ \beta_3 t + \beta_4 I(t > t^*) + \epsilon_{t}$

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \boldsymbol{Z}_t\beta_2 + \beta_3 t + \beta_4 I(t > t^*) + \beta_5 I(t > t^*)* t  + \epsilon_{t}$

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \beta_2 t + \beta_3 I(t > t^*) + \epsilon_{t}$

$ln(mortality_{t}) = \beta_0 + \boldsymbol{X}_{t} \beta_1 + \beta_2 t + \beta_3 I(t > t^*) + \beta_4 I(t > t^*)* t  + \epsilon_{t}$

Data cleaning
```{r data cleaning}
dat <- dataset %>% 
  select(year,
         city,
         city_id,
         percent_female,
         percent_nonwhite,
         percent_foreign,
         percent_age_less15,
         percent_age_15to44,
         percent_age_45plus, 
         ln_mortality_rate,
         ln_mortality_under1_rate,
         ln_typhoid_rate,
         ln_diarrhea_rate,
         mortality_rate,
         mortality_under1_rate,
         typhoid_rate,
         diarrhea_rate,
         filter, chlorination, water_project) %>% 
    mutate(filter = ifelse(filter == 1, 1, 0),
         chlorination = ifelse(chlorination == 1, 1, 0),
         water_project = ifelse(water_project == 1, 1, 0))

start_year <- dat %>% 
  arrange(city, by_group = year) %>% 
  mutate(filter1 = ifelse(filter == 0, 10000, year),
          ch1 = ifelse(chlorination == 0, 10000, year),
         water1 = ifelse(water_project == 0, 10000, year)) %>% 
  group_by(city) %>% 
  summarise(filter_start = min(filter1),
            ch_start = min(ch1),
            water_start = min(water1)) %>% 
  mutate(filter_start = ifelse(filter_start == 10000, 1940, filter_start),
         ch_start = ifelse(ch_start == 10000, 1940, ch_start),
         water_start = ifelse(water_start == 10000, 1940, water_start)) 

start_year$start <- apply(start_year, 1, min)

dat <- left_join(dat, start_year) %>% 
  mutate(filter_t = year - filter_start,
         ch_t = year - ch_start,
         water_t = year - water_start,
         filter_knot = ifelse(filter_t <=0, 0, 1),
         ch_knot = ifelse(ch_t <= 0, 0, 1),
         water_knot = ifelse(water_t <= 0, 0, 1)) %>% 
  mutate(t = year - as.numeric(start),
         trt = ifelse( filter + chlorination + water_project == 0, 0, 1),
         trt_knot = ifelse(t <= 0, 0, 1))


```

```{r}
dat <- dat %>% mutate(trt_1 = t,
               trt_2 = bin_number(t/2),
               trt_3 = bin_number(t/3),
               trt_5 = bin_number(t/5),
               trt_7 = bin_number(t/7),
               trt_10 = bin_number(t/10))
```

```{r}
# dat %>% 
#   group_by(trt_1) %>% 
#   summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_1, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_2) %>% 
#   summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_2, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_3) %>% 
#   summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_3, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(trt_5) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = trt_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "all cause mortality rate", x = "time relative to the start of treatment", y = "average log all cause mortality rate")


# dat %>% 
#   group_by(trt_7) %>% 
#   summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_10) %>% 
#   summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```

```{r}
# dat %>% 
#   group_by(trt_1) %>% 
#   summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_1, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_2) %>% 
#   summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_2, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_3) %>% 
#   summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_3, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(trt_5) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = trt_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "Infant mortality rate", x = "time relative to the start of treatment", y = "average log infant mortality rate")


# dat %>% 
#   group_by(trt_7) %>% 
#   summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_10) %>% 
#   summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```

```{r}
# dat %>% 
#   group_by(trt_1) %>% 
#   summarize(mean = mean(ln_typhoid_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_1, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_2) %>% 
#   summarize(mean = mean(ln_typhoid_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_2, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_3) %>% 
#   summarize(mean = mean(ln_typhoid_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_3, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(trt_5) %>% 
  summarize(mean = mean(ln_typhoid_rate), n = n()) %>% 
  ggplot() + 
  aes(x = trt_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "typhoid mortality", x = "time relative to the start of treatment", y = "average log typhoid mortality rate")


# dat %>% 
#   group_by(trt_7) %>% 
#   summarize(mean = mean(ln_typhoid_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_10) %>% 
#   summarize(mean = mean(ln_typhoid_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```

```{r}
# dat %>% 
#   group_by(trt_1) %>% 
#   summarize(mean = mean(ln_diarrhea_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_1, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_2) %>% 
#   summarize(mean = mean(ln_diarrhea_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_2, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_3) %>% 
#   summarize(mean = mean(ln_diarrhea_rate), n = n()) %>% 
#   ggplot() + 
#   aes(x = trt_3, y = mean, size = n) + 
#   geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(trt_5) %>% 
  summarize(mean = mean(ln_diarrhea_rate), n = n()) %>% 
  ggplot() + 
  aes(x = trt_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "Diarrhea mortality", x = "time relative to the start of treatment", y = "average log diarrhea mortality rate")


# dat %>% 
#   group_by(trt_7) %>% 
#   summarize(mean = mean(ln_diarrhea_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")
# 
# dat %>% 
#   group_by(trt_10) %>% 
#   summarize(mean = mean(ln_diarrhea_rate), n = n()) %>% 
#   ggplot() + aes(x = trt_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
#   geom_vline(xintercept = 0, color = "blue") +
#   labs(title = "average mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```



```{r}
dat <- as.data.frame(dat)

h <- c(3, 5, 7, 10)

beta.linear <- se.linear <- matrix(NA, nrow = 4, ncol = 4)

rownames(beta.linear) <- rownames(se.linear) <- c("all_mortality", "infant_mortality", "typhoid_mortality", "diarrhea_mortality")

colnames(beta.linear) <- colnames(se.linear) <- c("h = 3", "h = 5", "h = 7", "h = 10")

for (i in 1:length(h)){
  
  data <- dat[dat$t >= -h[i] & dat$t <= h[i], ]
  
  
  ### water filtration
  mort.linear <- lm(ln_mortality_rate ~ trt_knot * t, data = data)
  
  infant.linear <- lm( ln_mortality_under1_rate ~ trt_knot * t, data = data)
  
  
  ty.linear <- lm( ln_typhoid_rate ~ trt_knot * t, data = data)
  
  di.linear <- lm(ln_diarrhea_rate ~ trt_knot * t, data = data)
  
  
  
  beta.linear[, i] <- c(summary(mort.linear)$coefficients[2,1], 
                            summary(infant.linear)$coefficients[2,1],
                            summary(ty.linear)$coefficients[2,1],
                            summary(di.linear)$coefficients[2,1])
  
  se.linear[, i] <- c(summary(mort.linear)$coefficients[2,2], 
                            summary(infant.linear)$coefficients[2,2],
                            summary(ty.linear)$coefficients[2,2],
                            summary(di.linear)$coefficients[2,2])
}
```

```{r}
beta.linear
se.linear
```

```{r}
beta.linear - 1.96*se.linear
beta.linear + 1.96*se.linear
```



### RDD with different value of h

#### informal visualization test of choosing value of h
```{r}
bin_number <- function(x){
  if (x > 0){
    ceiling(x)
  } else {
    floor(x)
  }
}

dat <- dat %>% mutate(filter_1 = filter_t,
               filter_2 = bin_number(filter_t/2),
               filter_3 = bin_number(filter_t/3),
               filter_5 = bin_number(filter_t/5),
               filter_7 = bin_number(filter_t/7),
               filter_10 = bin_number(filter_t/10),
               
               ch_1 = ch_t,
               ch_2 = bin_number(ch_t/2),
               ch_3 = bin_number(ch_t/3),
               ch_5 = bin_number(ch_t/5),
               ch_7 = bin_number(ch_t/7),
               ch_10 = bin_number(ch_t/10),
               
               water_1 = water_t,
               water_2 = bin_number(water_t/2),
               water_3 = bin_number(water_t/3),
               water_5 = bin_number(water_t/5),
               water_7 = bin_number(water_t/7),
               water_10 = bin_number(water_t/10))
```

### for mortality rate

for water filtration: Clear jump before and after 0 at h = 5
```{r}
dat %>% 
  group_by(filter_1) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_1, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_2) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_2, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_3) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_3, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_5) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 5", x = "time relative to the start of health policy", y = "average log mortality rate")


dat %>% 
  group_by(filter_7) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + aes(x = filter_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_10) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + aes(x = filter_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```
for chlorination: clear jump at bin size = 7
```{r}
dat %>% 
  group_by(ch_1) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_1, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_2) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_2, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_3) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_3, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_5) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 5", x = "time relative to the start of health policy", y = "average log mortality rate")


dat %>% 
  group_by(ch_7) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + aes(x = ch_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_10) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + aes(x = ch_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```


for Clean water: 
```{r}
dat %>% 
  group_by(water_1) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_1, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_2) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_2, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_3) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_3, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_5) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 5", x = "time relative to the start of health policy", y = "average log mortality rate")


dat %>% 
  group_by(water_7) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + aes(x = water_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_10) %>% 
  summarize(mean = mean(ln_mortality_rate), n = n()) %>% 
  ggplot() + aes(x = water_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```

infant mortality rate and water filtration
```{r}
dat %>% 
  group_by(filter_1) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_1, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_2) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_2, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_3) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_3, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_5) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = filter_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 5", x = "time relative to the start of health policy", y = "average log mortality rate")


dat %>% 
  group_by(filter_7) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + aes(x = filter_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(filter_10) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + aes(x = filter_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```

infant mortality and chlorination
```{r}
dat %>% 
  group_by(ch_1) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_1, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_2) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_2, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_3) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_3, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_5) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = ch_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 5", x = "time relative to the start of health policy", y = "average log mortality rate")


dat %>% 
  group_by(ch_7) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + aes(x = ch_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(ch_10) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + aes(x = ch_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```
infant mortality and clean water project
```{r}
dat %>% 
  group_by(water_1) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_1, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 1", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_2) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_2, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 2", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_3) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_3, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 3", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_5) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + 
  aes(x = water_5, y = mean, size = n) + 
  geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 5", x = "time relative to the start of health policy", y = "average log mortality rate")


dat %>% 
  group_by(water_7) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + aes(x = water_7, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") + 
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 7", x = "time relative to the start of health policy", y = "average log mortality rate")

dat %>% 
  group_by(water_10) %>% 
  summarize(mean = mean(ln_mortality_under1_rate), n = n()) %>% 
  ggplot() + aes(x = water_10, y = mean, size = n) + geom_point(shape = 21,color = "black",fill = "lightgray") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(title = "average infant mortality based on bin size = 10", x = "time relative to the start of health policy", y = "average log mortality rate")
```

```{r}
plot(x = dat$filter_t, y = dat$ln_mortality_rate)
plot(x = dat$filter_t, y = dat$ln_mortality_under1_rate)
plot(x = dat$filter_t, y = dat$ln_typhoid_rate)
plot(x = dat$filter_t, y = dat$ln_diarrhea_rate)
```



#### estimate average causal effect with RDD using local linear regression

#### find the optimal bandwidth with leave-one-out crossvalidation tailored for RD
```{r}
# find.h <- function(data, outcome, time_variable, bandwidth){
#   data <- as.data.frame(data)
#   
#   mse.left <- numeric(100)
#   mse.right <- numeric(100)
#   
#   left.index <- abs((min(data$time_variable) + bandwidth))
#   right.index <- max(data$time_variable) - bandwidth
#   
#   for (i in 1: left.index ){
#   fit.data.left <- data[data$time_variable <= -i & data$time_variable >= -(i+bandwidth), ]
#   mod.left <- lm(outcome ~ time_variable, data = fit.data.left)
#   mse.left[i+1] <- mean((predict(mod.left) - fit.data.left$outcome)^2)
#   }
#   
#   
#   for (i in 1:right.index){
#   fit.data.right <- data[data$time_variable >= i & data$time_variable <= i+bandwidth, ]
#   mod.right <- lm(outcome ~ time_variable, data = fit.data.right)
#   mse.right[i+1] <- mean((predict(mod.right) - fit.data.right$outcome)^2)
#   }
#   }
```


```{r}
#find.h(dat, ln_mortality_rate, filter_t, bandwidth = 5)
```



### estimate ACE with different window size
```{r}
# dat <- as.data.frame(dat)
# 
# h <- c(3, 5, 7, 10)
# var <- c("filter_t", "ch_t", "water_t")
# trt <- c("filter_knot", "ch_knot", "water_knot")
# outcome <- c("ln_mortality_rate", "ln_mortality_under1_rate", "ln_typhoid_rate", "ln_diarrhea_rate")
# 
# 
# for (i in 1:length(h)){
#   for (j in 1:length(var)){
#   data <- dat[dat$var[j] >= -h[i] & dat$var[j] <= h[i], ]
#   
#   mod.linear <- lm(ln_mortality_rate ~ var[j] + trt[j], data = data)
#   beta.trt1[i, j] <- summary(mod.linear)$coefficients[trt[j]]
#   
#   # mod.inter <- lm(ln_mortality_rate ~ data$var[j] * data$trt[j], data = data)
#   # beta.trt2 <- summary(mod.inter)$coefficients[trt[j]]
#   }
#   
#   
# }

```
```{r}
# beta.trt1 <- rep(NA, length(var))
# for (i in 1:length(var)){
#   data <- dat[dat$var[i] >= -3 & dat$var[i] <= 3, ]
#   head(data)
#   var1 <- cat(var[i], "\n") ## remove the quotation marks
#   trt1 <- cat(trt[i], "\n")
#   mod.linear <- lm(ln_mortality_rate ~ var1 + trt1, data = data)
#   beta.trt1[i] <- summary(mod.linear)$coefficients[trt1]
# }
```



```{r}
dat <- as.data.frame(dat)

h <- c(3, 5, 7, 10)
var <- c("filter_t", "ch_t", "water_t")
trt <- c("filter_knot", "ch_knot", "water_knot")
outcome <- c("ln_mortality_rate", "ln_mortality_under1_rate", "ln_typhoid_rate", "ln_diarrhea_rate")

filter.beta.linear <- filter.se.linear <- ch.beta.linear <- water.se.linear <- water.beta.linear <- ch.se.linear <- matrix(NA, nrow = 4, ncol = 4)

rownames(filter.beta.linear) <- rownames(filter.se.linear) <- rownames(ch.beta.linear) <- rownames(water.se.linear) <- rownames(water.beta.linear) <- rownames(ch.se.linear) <- c("all_mortality", "infant_mortality", "typhoid_mortality", "diarrhea_mortality")

colnames(filter.beta.linear) <- colnames(filter.se.linear) <- colnames(ch.beta.linear) <- colnames(water.se.linear) <- colnames(water.beta.linear) <- colnames(ch.se.linear) <- c("h = 3", "h = 5", "h = 7", "h = 10")

for (i in 1:length(h)){
  
  data.filter <- dat[dat$filter_t >= -h[i] & dat$filter_t <= h[i], ]
  data.ch <- dat[dat$ch_t >= -h[i] & dat$ch_t <= h[i], ]
  data.water <- dat[dat$water_t >= -h[i] & dat$water_t <= h[i], ]
  
  ### water filtration
  filter.mort.linear <- lm(ln_mortality_rate ~ filter_knot + filter_t, data = data.filter)
  filter.mort.int <- lm(ln_mortality_rate ~ filter_knot * filter_t, data = data.filter)
  
  filter.infant.linear <- lm( ln_mortality_under1_rate ~ filter_knot + filter_t, data = data.filter)
  filter.infant.int <- lm( ln_mortality_under1_rate ~ filter_knot * filter_t, data = data.filter)
  
  filter.ty.linear <- lm( ln_typhoid_rate ~ filter_knot + filter_t, data = data.filter)
  filter.ty.int <- lm( ln_typhoid_rate ~ filter_knot * filter_t, data = data.filter)
  
  filter.di.linear <- lm(ln_diarrhea_rate ~ filter_knot + filter_t, data = data.filter)
  filter.di.int <- lm(ln_diarrhea_rate ~ filter_knot * filter_t, data = data.filter)
  
  
  filter.beta.linear[, i] <- c(summary(filter.mort.linear)$coefficients[2,1], 
                            summary(filter.infant.linear)$coefficients[2,1],
                            summary(filter.ty.linear)$coefficients[2,1],
                            summary(filter.di.linear)$coefficients[2,1])
  
  filter.se.linear[, i] <- c(summary(filter.mort.linear)$coefficients[2,2], 
                            summary(filter.infant.linear)$coefficients[2,2],
                            summary(filter.ty.linear)$coefficients[2,2],
                            summary(filter.di.linear)$coefficients[2,2])
  
  # filter.beta.int[, i] <- c(summary(filter.mort.int)$coefficients[2,1], 
  #                           summary(filter.infant.int)$coefficients[2,1],
  #                           summary(filter.ty.int)$coefficients[2,1],
  #                           summary(filter.di.int)$coefficients[2,1])
  
  # filter.beta.int[, i] <- c(summary(filter.mort.int)$coefficients[filter_knot], 
  #                           summary(filter.infant.int)$coefficients[filter_knot],
  #                           summary(filter.ty.int)$coefficients[filter_knot],
  #                           summary(filter.di.int)$coefficients[filter_knot])
  
  ### chlorination
  ch.mort.linear <- lm(ln_mortality_rate ~ ch_knot + ch_t, data = data.ch)
  ch.mort.int <- lm(ln_mortality_rate ~ ch_knot * ch_t, data = data.ch)
  
  ch.infant.linear <- lm( ln_mortality_under1_rate ~ ch_knot + ch_t, data = data.ch)
  ch.infant.int <- lm( ln_mortality_under1_rate ~ ch_knot * ch_t, data = data.ch)
  
  ch.ty.linear <- lm( ln_typhoid_rate ~ ch_knot + ch_t, data = data.ch)
  ch.ty.int <- lm( ln_typhoid_rate ~ ch_knot * ch_t, data = data.ch)
  
  ch.di.linear <- lm(ln_diarrhea_rate ~ ch_knot + ch_t, data = data.ch)
  ch.di.int <- lm(ln_diarrhea_rate ~ ch_knot * ch_t, data = data.ch)
  
  ch.beta.linear[, i] <- c(summary(ch.mort.linear)$coefficients[2,1], 
                            summary(ch.infant.linear)$coefficients[2,1],
                            summary(ch.ty.linear)$coefficients[2,1],
                            summary(ch.di.linear)$coefficients[2,1])
  
  ch.se.linear[, i] <- c(summary(ch.mort.int)$coefficients[2,2],
                            summary(ch.infant.int)$coefficients[2,2],
                            summary(ch.ty.int)$coefficients[2,2],
                            summary(ch.di.int)$coefficients[2,2])
  
  # ch.beta.int[, i] <- c(summary(ch.mort.int)$coefficients[ch_knot],
  #                           summary(ch.infant.int)$coefficients[ch_knot],
  #                           summary(ch.ty.int)$coefficients[ch_knot],
  #                           summary(ch.di.int)$coefficients[ch_knot])
  
  ### clean water project
  water.mort.linear <- lm(ln_mortality_rate ~ water_knot + water_t, data = data.water)
  water.mort.int <- lm(ln_mortality_rate ~ water_knot * water_t, data = data.water)
  
  water.infant.linear <- lm( ln_mortality_under1_rate ~ water_knot + water_t, data = data.water)
  water.infant.int <- lm( ln_mortality_under1_rate ~ water_knot * water_t, data = data.water)
  
  water.ty.linear <- lm( ln_typhoid_rate ~ water_knot + water_t, data = data.water)
  water.ty.int <- lm( ln_typhoid_rate ~ water_knot * water_t, data = data.water)
  
  water.di.linear <- lm(ln_diarrhea_rate ~ water_knot + water_t, data = data.water)
  water.di.int <- lm(ln_diarrhea_rate ~ water_knot * water_t, data = data.water)


  water.beta.linear[, i] <- c(summary(water.mort.linear)$coefficients[2,1], 
                            summary(water.infant.linear)$coefficients[2,1],
                            summary(water.ty.linear)$coefficients[2,1],
                            summary(water.di.linear)$coefficients[2,1])
  
  water.se.linear[, i] <- c(summary(water.mort.int)$coefficients[2,2],
                            summary(water.infant.int)$coefficients[2,2],
                            summary(water.ty.int)$coefficients[2,2],
                            summary(water.di.int)$coefficients[2,2])
  
  # water.beta.int[, i] <- c(summary(water.mort.int)$coefficients[water_knot], 
  #                           summary(water.infant.int)$coefficients[water_knot],
  #                           summary(water.ty.int)$coefficients[water_knot],
  #                           summary(water.di.int)$coefficients[water_knot])
}
```

```{r}
filter.beta.linear
#filter.se.linear 
ch.beta.linear 
#water.se.linear
water.beta.linear
#ch.se.linear
```

```{r}
filter.beta.up <- filter.beta.linear + 1.96*filter.se.linear
filter.beta.low <- filter.beta.linear - 1.96*filter.se.linear
filter.beta.up
filter.beta.low
```

```{r}
ch.beta.up <- ch.beta.linear + 1.96*ch.se.linear
ch.beta.low <- ch.beta.linear - 1.96*ch.se.linear
ch.beta.up
ch.beta.low
```

```{r}
water.beta.up <- water.beta.linear + 1.96*water.se.linear
water.beta.low <- water.beta.linear - 1.96*water.se.linear
water.beta.up
water.beta.low
```


## treatment effect of water filteration
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot, data = dat))
```

## treatment effect of chlorination
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot, data = dat))
```

### clean water project
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot, data = dat))

```


### RD model 2

```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot + filter_knot*filter_t, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot + filter_knot*filter_t, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot*filter_t, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + filter_t + filter_knot + filter_knot*filter_t, data = dat))
```

## chlorination
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat))
```

## plot observed data with fitted line
```{r}
#all cause mortality
dat.pred.nocov <- 
  dat %>% 
  select(ch_t,ch_knot) %>%
  distinct()

#unadjusted model
mod.mort.nocov <- glm(ln_mortality_rate ~ ch_knot*ch_t, data = dat)
#generate predicted values based on the model in order to create a plot
y.mort.nocov <- predict(mod.mort.nocov, newdata = dat.pred.nocov, type = "response")
#to create the counter-factual scenario we create a data frame as if the intervention was never being implemented
dat.pred.nocov.ct <- 
  dat %>% 
  select(ch_t,ch_knot) %>%
  filter(ch_knot==1) %>%
  mutate(ch_knot=0) %>%
  distinct()
#generate fitted value for counter-factual scenario
y.mort.nocov.ct <- predict(mod.mort.nocov, newdata = dat.pred.nocov.ct, type = "response")

#plot
fig_mort <- ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_mortality_rate),color="darkgrey") +
  geom_line(aes(x = dat.pred.nocov$ch_t, y = y.mort.nocov),color="red") + # fitted line
  geom_line(aes(x = dat.pred.nocov.ct$ch_t, y = y.mort.nocov.ct),color="red",linetype="dashed") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log all-cause mortality")+
  theme(legend.position = "none") +
  theme_bw()

#adjusted model
dat.pred <- dat %>% select(
                           percent_female,
                           percent_nonwhite,
                           percent_foreign,
                           percent_age_less15,
                           percent_age_15to44,
                           percent_age_45plus,
                           ch_t, 
                           ch_knot)

mod.mort <- glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)

y.mort <- predict(mod.mort, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_mortality_rate)) +
  geom_point(aes(x = dat$ch_t, y = y.mort, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log all-cause mortality")+
  theme(legend.position = "none")


#infant mortality
#unadjusted model
mod.in.nocov <- glm(ln_mortality_under1_rate ~ ch_knot*ch_t, data = dat)
#generate predicted values based on the model in order to create a plot
y.in.nocov <- predict(mod.in.nocov, newdata = dat.pred.nocov, type = "response")
#generate fitted value for counter-factual scenario
y.in.nocov.ct <- predict(mod.in.nocov, newdata = dat.pred.nocov.ct, type = "response")

#plot
fig_in <- ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_mortality_under1_rate),color="darkgrey") +
  geom_line(aes(x = dat.pred.nocov$ch_t, y = y.in.nocov),color="red") + # fitted line
  geom_line(aes(x = dat.pred.nocov.ct$ch_t, y = y.in.nocov.ct),color="red",linetype="dashed") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log infant mortality")+
  theme(legend.position = "none") +
  theme_bw()

#adjusted model
mod.in <- glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)

y.in <- predict(mod.in, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_mortality_under1_rate) )+
  geom_point(aes(x = dat$ch_t, y = y.in, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log infant mortality")+
  theme(legend.position = "none")


#typhoid mortality
#unadjusted model
mod.ty.nocov <- glm(ln_typhoid_rate ~ ch_knot*ch_t, data = dat)
#generate predicted values based on the model in order to create a plot
y.ty.nocov <- predict(mod.ty.nocov, newdata = dat.pred.nocov, type = "response")
#generate fitted value for counter-factual scenario
y.ty.nocov.ct <- predict(mod.ty.nocov, newdata = dat.pred.nocov.ct, type = "response")

#plot
fig_ty <- ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_typhoid_rate),color="darkgrey") +
  geom_line(aes(x = dat.pred.nocov$ch_t, y = y.ty.nocov),color="red") + # fitted line
  geom_line(aes(x = dat.pred.nocov.ct$ch_t, y = y.ty.nocov.ct),color="red",linetype="dashed") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log typhoid mortality")+
  theme(legend.position = "none") +
  theme_bw()

#adjusted model
mod.ty <- glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)

y.ty <- predict(mod.ty, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_typhoid_rate) )+
  geom_point(aes(x = dat$ch_t, y = y.ty, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log typhoid mortality")+
  theme(legend.position = "none")


#diarrhea mortality
#unadjusted model
mod.di.nocov <- glm(ln_diarrhea_rate ~ ch_knot*ch_t, data = dat)
#generate predicted values based on the model in order to create a plot
y.di.nocov <- predict(mod.di.nocov, newdata = dat.pred.nocov, type = "response")
#generate fitted value for counter-factual scenario
y.di.nocov.ct <- predict(mod.di.nocov, newdata = dat.pred.nocov.ct, type = "response")

#plot
fig_di <- ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_diarrhea_rate),color="darkgrey") +
  geom_line(aes(x = dat.pred.nocov$ch_t, y = y.di.nocov),color="red") + # fitted line
  geom_line(aes(x = dat.pred.nocov.ct$ch_t, y = y.di.nocov.ct),color="red",linetype="dashed") +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log diarrhea mortality")+
  theme(legend.position = "none") +
  theme_bw()

#adjusted model
mod.di <- glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + ch_t + ch_knot*ch_t, data = dat)


y.di <- predict(mod.di, newdata = dat.pred)

ggplot() +
  geom_point(aes(x = dat$ch_t, y = dat$ln_diarrhea_rate) )+
  geom_point(aes(x = dat$ch_t, y = y.di, color = as.factor(dat$ch_knot + 1))) +
  geom_vline(xintercept = 0, color = "blue") +
  labs(x = "year relative to start of treatment", y = "log diarrhea mortality")+
  theme(legend.position = "none")

#combine the four unadjusted plots to one and save the figure
#required package
#if(!require(devtools)) install.packages("devtools")
#devtools::install_github("kassambara/ggpubr")
library(ggpubr)
# 1. Open jpeg file
#jpeg("unadj_ITS_chl.jpg", width = 12, height = 8, units = 'in', res = 500)
# 2. Create the plot
ggarrange(fig_mort, fig_in, fig_ty, fig_di, 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2)
# 3. Close the file
#dev.off()


#save ITS regression results 

#unadjusted ch 
output_mort_unadj <- data.frame(round(coef(summary(mod.mort.nocov)),4))
output_in_unadj <- data.frame(round(coef(summary(mod.in.nocov)),4))
output_ty_unadj <- data.frame(round(coef(summary(mod.ty.nocov)),4))
output_di_unadj <- data.frame(round(coef(summary(mod.di.nocov)),4))

output_unadj <- rbind(output_mort_unadj,output_in_unadj,output_ty_unadj,output_di_unadj)
write.csv(output_unadj,"ITS_unadj_coef.csv")
#adjusted
output_mort_adj <- data.frame(round(coef(summary(mod.mort)),4))
output_in_adj <- data.frame(round(coef(summary(mod.in)),4))
output_ty_adj <- data.frame(round(coef(summary(mod.ty)),4))
output_di_adj <- data.frame(round(coef(summary(mod.di)),4))

output_adj <- rbind(output_mort_adj, output_in_adj,output_ty_adj,output_di_adj)
write.csv(output_adj,"ITS_adj_coef.csv")

```




## water project
```{r}
summary(glm(ln_mortality_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))

summary(glm(ln_mortality_under1_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))

summary(glm(ln_typhoid_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))

summary(glm(ln_diarrhea_rate ~ percent_female + percent_nonwhite + percent_foreign + percent_age_less15 + percent_age_15to44 + percent_age_45plus + water_t + water_knot*water_t, data = dat))
```

Code from Interrupted time series regression for the evaluation of public health interventions: a tutorial by James Lopez Bernal, Steven Cummins, Antonio Gasparrini
```{r}
# Install packages required for the analysis (uncomment if needed)
#install.packages("lmtest") ; install.packages("Epi")
#install.packages("tsModel"); install.packages("vcd")

# load the packages
library(foreign)
library(tsModel)
library("lmtest")
library("Epi")
library("splines")
library("vcd")

## Scatter plot
# start the plot, excluding the points and the x-axis
plot(dat$mortality_rate,type="n",ylim=c(600,2800),xlab="Year", ylab="Std rate x 100,000",
  bty="l")
# shade the post intervention period grey
rect(36,0,60,300,col=grey(0.9),border=F)
# plot the observed rate for pre-intervention period
points(dat$mortality_rate,cex=0.7)
#specify the x-axis (i.e. time units)
axis(1,at=0:25*12,labels=F)
axis(1,at=0:40*12,tick=F)
# add a title
title("Sicily, 2002-2006")



```


```{r}
#example
# read data from csv file
data <- read.csv("sicily.csv")
head(data)
View(data)

#Poisson with the standardised population as an offset
model1 <- glm(aces ~ offset(log(stdpop)) + smokban + time, family=poisson, data)
summary(model1)
summary(model1)$dispersion
round(ci.lin(model1,Exp=T),3)

# create a new dataframe with 0.1 time units to improve the graph
datanew <- data.frame(stdpop=mean(data$stdpop),smokban=rep(c(0,1),c(360,240)),
  time= 1:600/10,month=rep(1:120/10,5))

# We generate predicted values based on the model in order to create a plot
pred1 <- predict(model1,type="response",datanew)/mean(data$stdpop)*10^5

#This can then be plotted along with a scatter graph (see above)
plot(data$rate,type="n",ylim=c(0,300),xlab="Year",ylab="Std rate x 10,000",
  bty="l",xaxt="n")
rect(36,0,60,300,col=grey(0.9),border=F)
points(data$rate,cex=0.7)
axis(1,at=0:5*12,labels=F)
axis(1,at=0:4*12+6,tick=F,labels=2002:2006)
lines((1:600/10),pred1,col=2)
title("Sicily, 2002-2006")

# to plot the counterfactual scenario we create a data frame as if smokban
#   (the intervention) was never being implemented
datanew <- data.frame(stdpop=mean(data$stdpop),smokban=0,time=1:600/10,
  month=rep(1:120/10,5))

# generate predictions under the counterfactual scenario and add it to the plot
pred1b <- predict(model1,datanew,type="response")/mean(data$stdpop)*10^5
lines(datanew$time,pred1b,col=2,lty=2)

# return the data frame to the scenario including the intervention
datanew <- data.frame(stdpop=mean(data$stdpop),smokban=rep(c(0,1),c(360,240)),
  time= 1:600/10,month=rep(1:120/10,5))

```


